<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; }
body {
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  background: #0a0a0a;
  color: #e0e0e0;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ── SIDEBAR ─────────────────────────── */
.sidebar {
  width: 160px;
  background: #0a0a0a;
  border-right: 1px solid #1a1a1a;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  padding: 20px 0;
}
.sidebar-brand {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 2px;
  color: #555;
  padding: 0 20px 24px;
  text-transform: uppercase;
}
.nav-item {
  padding: 9px 20px;
  font-size: 13px;
  color: #555;
  cursor: pointer;
  transition: color 0.15s;
  user-select: none;
}
.nav-item:hover { color: #aaa; }
.nav-item.active { color: #fff; font-weight: 500; }
.sidebar-footer {
  margin-top: auto;
  padding: 16px 20px;
  border-top: 1px solid #1a1a1a;
  font-size: 11px;
}
.bot-status {
  display: flex;
  align-items: center;
  gap: 7px;
  margin-bottom: 6px;
}
.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #22c55e;
  flex-shrink: 0;
}
.status-dot.off { background: #ef4444; }
.status-text { color: #555; }
.last-update { color: #333; font-size: 10px; }

/* ── MAIN ────────────────────────────── */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.topbar {
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  border-bottom: 1px solid #1a1a1a;
  flex-shrink: 0;
}
.page-title {
  font-size: 16px;
  font-weight: 500;
  color: #fff;
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 12px;
  color: #555;
}
.topbar-right span { cursor: pointer; }
.topbar-right span:hover { color: #aaa; }

.content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}
.content::-webkit-scrollbar { width: 4px; }
.content::-webkit-scrollbar-thumb { background: #1a1a1a; }

/* ── PAGES ───────────────────────────── */
.page { display: none; }
.page.active { display: block; }

/* ── STAT CARDS ──────────────────────── */
.stats-row {
  display: grid;
  gap: 12px;
  margin-bottom: 16px;
}
.stats-5 { grid-template-columns: repeat(5, 1fr); }
.stats-3 { grid-template-columns: repeat(3, 1fr); }
.stats-2 { grid-template-columns: repeat(2, 1fr); }
.stat-card {
  background: #111;
  border: 1px solid #1a1a1a;
  border-radius: 8px;
  padding: 16px 18px;
}
.stat-label {
  font-size: 11px;
  color: #555;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.stat-value {
  font-size: 22px;
  font-weight: 500;
  color: #fff;
  line-height: 1;
  margin-bottom: 4px;
}
.stat-sub { font-size: 11px; color: #444; }
.c-green { color: #22c55e !important; }
.c-red { color: #ef4444 !important; }
.c-blue { color: #3b82f6 !important; }
.c-yellow { color: #eab308 !important; }
.c-gray { color: #555 !important; }
.c-white { color: #fff !important; }

/* ── PANEL ───────────────────────────── */
.panel {
  background: #111;
  border: 1px solid #1a1a1a;
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}
.panel-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 18px;
  border-bottom: 1px solid #1a1a1a;
}
.panel-label {
  font-size: 11px;
  font-weight: 500;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.panel-badge {
  font-size: 11px;
  background: #1a1a1a;
  color: #555;
  padding: 2px 8px;
  border-radius: 4px;
}
.panel-body { padding: 18px; }

/* ── GRID LAYOUT ─────────────────────── */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }

/* ── TABLE ───────────────────────────── */
.tbl { width: 100%; border-collapse: collapse; }
.tbl th {
  padding: 10px 18px;
  text-align: left;
  font-size: 11px;
  color: #444;
  font-weight: 400;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid #1a1a1a;
}
.tbl td {
  padding: 11px 18px;
  border-bottom: 1px solid #141414;
  font-size: 13px;
  color: #ccc;
}
.tbl tr:last-child td { border-bottom: none; }
.tbl tr:hover td { background: #131313; }
.tbl-empty {
  padding: 40px;
  text-align: center;
  color: #333;
  font-size: 13px;
}

/* ── BADGES ──────────────────────────── */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
}
.badge-long { background: rgba(34,197,94,0.1); color: #22c55e; }
.badge-short { background: rgba(239,68,68,0.1); color: #ef4444; }
.badge-ok { background: rgba(34,197,94,0.1); color: #22c55e; }
.badge-hit { background: rgba(239,68,68,0.1); color: #ef4444; }
.badge-neutral { background: #1a1a1a; color: #555; }

/* ── PERFORMANCE ROW ─────────────────── */
.perf-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 9px 0;
  border-bottom: 1px solid #141414;
  font-size: 13px;
}
.perf-row:last-child { border-bottom: none; }
.perf-k { color: #555; }
.perf-v { color: #ccc; font-weight: 500; }

/* ── SAFETY ROW ──────────────────────── */
.safety-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 9px 0;
  border-bottom: 1px solid #141414;
}
.safety-row:last-child { border-bottom: none; }

/* ── CHART ───────────────────────────── */
.chart-wrap { padding: 8px 4px; position: relative; }
.chart-wrap canvas { max-height: 200px; }

/* ── PROGRESS ────────────────────────── */
.progress {
  height: 3px;
  background: #1a1a1a;
  border-radius: 2px;
  overflow: hidden;
  margin: 6px 0 3px;
}
.progress-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.4s;
}
.pf-green { background: #22c55e; }
.pf-gradient { background: linear-gradient(90deg,#22c55e,#eab308,#ef4444); }

/* ── POSITION PROGRESS BAR ───────────── */
.pos-progress-wrap {
  padding: 12px 18px 10px;
  border-bottom: 1px solid #141414;
  background: #0d0d0d;
}
.pos-progress-header {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: #444;
  margin-bottom: 6px;
}
.pos-progress-bar {
  height: 5px;
  background: #1a1a1a;
  border-radius: 3px;
  overflow: visible;
  position: relative;
}
.pos-progress-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
  position: relative;
}
.pos-progress-markers {
  display: flex;
  justify-content: space-between;
  font-size: 9px;
  color: #333;
  margin-top: 4px;
}
.marker-be { color: #eab308; }
.marker-trail { color: #3b82f6; }
.marker-tp { color: #22c55e; }

/* ── CONTROL BUTTONS ─────────────────── */
.btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
.btn {
  padding: 8px 16px;
  border-radius: 6px;
  border: 1px solid;
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-start { border-color: #22c55e; color: #22c55e; background: rgba(34,197,94,0.06); }
.btn-start:hover { background: #22c55e; color: #000; }
.btn-stop { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,0.06); }
.btn-stop:hover { background: #ef4444; color: #fff; }
.btn-reset { border-color: #3b82f6; color: #3b82f6; background: rgba(59,130,246,0.06); }
.btn-reset:hover { background: #3b82f6; color: #fff; }
.btn-neutral { border-color: #333; color: #666; background: transparent; }
.btn-neutral:hover { border-color: #555; color: #aaa; }

/* ── SCAN STATS ──────────────────────── */
.scan-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 1px;
  background: #1a1a1a;
  border-radius: 6px;
  overflow: hidden;
}
.scan-item {
  background: #111;
  padding: 14px 12px;
  text-align: center;
}
.scan-label { font-size: 10px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.scan-value { font-size: 18px; font-weight: 500; }

/* ── MARKET ──────────────────────────── */
.market-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #1a1a1a; }
.market-item { background: #111; padding: 14px 18px; }
.market-label { font-size: 10px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.market-value { font-size: 16px; font-weight: 500; color: #fff; }
.market-sub { font-size: 11px; color: #444; margin-top: 2px; }

/* ── NOTIF ───────────────────────────── */
.notif-stack {
  position: fixed;
  bottom: 16px; right: 16px;
  z-index: 999;
  display: flex;
  flex-direction: column-reverse;
  gap: 6px;
}
.notif {
  background: #111;
  border: 1px solid #222;
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 12px;
  min-width: 220px;
  animation: slideUp 0.2s ease;
}
@keyframes slideUp { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.notif-win { border-left: 2px solid #22c55e; }
.notif-loss { border-left: 2px solid #ef4444; }
.notif-info { border-left: 2px solid #3b82f6; }
.n-title { font-weight: 500; margin-bottom: 2px; }
.n-body { color: #555; font-size: 11px; }

/* ── AI CHIPS ────────────────────────── */
.chip-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
.chip {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 4px;
  background: #1a1a1a;
  color: #555;
  border: 1px solid #222;
}

/* ── JOURNAL ─────────────────────────── */
.journal-entry {
  padding: 14px 0;
  border-bottom: 1px solid #1a1a1a;
}
.journal-entry:last-child { border-bottom: none; }
.journal-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
  font-size: 12px;
}
.journal-body { font-size: 12px; color: #666; line-height: 1.7; }

/* ── TRANSACTION TYPE ────────────────── */
.tx-deposit { color: #22c55e; }
.tx-withdraw { color: #ef4444; }
.tx-trade { color: #3b82f6; }

/* ── ANTI COPY ───────────────────────────── */
body {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
/* Allow select on input only */
input, textarea { user-select: text; }

/* ── MODAL ───────────────────────────────── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 500;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: #111;
  border: 1px solid #1a1a1a;
  border-radius: 8px;
  width: 480px;
  max-width: 95vw;
  overflow: hidden;
}
.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  border-bottom: 1px solid #1a1a1a;
}
.modal-title { font-size: 13px; font-weight: 500; color: #fff; }
.modal-close {
  font-size: 18px;
  color: #444;
  cursor: pointer;
  line-height: 1;
  padding: 2px 6px;
  border-radius: 4px;
}
.modal-close:hover { color: #fff; background: #1a1a1a; }
.modal-body { padding: 16px 18px; }
.modal-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #141414;
  font-size: 13px;
}
.modal-row:last-child { border-bottom: none; }
.modal-k { color: #555; }
.modal-v { color: #ccc; font-weight: 500; }
</style>
</head>
<body>

<div class="notif-stack" id="notifs"></div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-brand">Dashboard</div>
  <div class="nav-item active" onclick="go('overview',this)">Overview</div>
  <div class="nav-item" onclick="go('positions',this)">Positions</div>
  <div class="nav-item" onclick="go('trades',this)">Trades</div>
  <div class="nav-item" onclick="go('analytics',this)">Analytics</div>
  <div class="nav-item" onclick="go('ai',this)">AI Engine</div>
  <div class="nav-item" onclick="go('journal',this)">Journal</div>
  <div class="nav-item" onclick="go('transactions',this)">Transactions</div>
  <div class="nav-item" onclick="go('control',this)">Control</div>

  <div class="sidebar-footer">
    <div class="bot-status">
      <div class="status-dot" id="bot-dot"></div>
      <span class="status-text" id="bot-status-text">Bot Running</span>
    </div>
    <div class="last-update" id="last-update">Updated: --:--</div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="page-title" id="page-title">Overview</div>
    <div class="topbar-right">
      <span id="tb-bal" style="color:#aaa;margin-right:8px"></span><span id="tb-mode" style="color:#eab308">PAPER</span>
      <span id="tb-time">--:--:--</span>
      <span onclick="go('control',document.querySelector('.nav-item:last-child'))" style="color:#333">admin</span>
    </div>
  </div>

  <div class="content">

    <!-- ══ OVERVIEW ══════════════════════════════════════ -->
    <div id="page-overview" class="page active">
      <div class="stats-row stats-5">
        <div class="stat-card">
          <div class="stat-label">Balance</div>
          <div class="stat-value" id="o-bal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Today P&L</div>
          <div class="stat-value c-green" id="o-dpnl">$+0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total P&L</div>
          <div class="stat-value c-green" id="o-tpnl">$+0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Win Rate</div>
          <div class="stat-value" id="o-wr">0%</div>
          <div class="stat-sub" id="o-trades">0 trades</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Positions</div>
          <div class="stat-value" id="o-pos">0</div>
        </div>
      </div>

      <div class="grid-2-1" style="margin-bottom:16px">
        <!-- Active Positions -->
        <div class="panel">
          <div class="panel-head">
            <span class="panel-label">Active Positions</span>
            <span class="panel-badge" id="o-pos-badge">0</span>
          </div>
          <table class="tbl">
            <thead>
              <tr><th>Symbol</th><th>Side</th><th>Entry</th><th>Current</th><th>PnL</th><th>Progress</th><th>Age</th></tr>
            </thead>
            <tbody id="o-pos-body">
              <tr><td colspan="7" class="tbl-empty">No open positions</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Right column -->
        <div>
          <div class="panel" style="margin-bottom:16px">
            <div class="panel-head"><span class="panel-label">Market</span></div>
            <div class="market-grid">
              <div class="market-item">
                <div class="market-label">Session</div>
                <div class="market-value" id="o-session">—</div>
              </div>
              <div class="market-item">
                <div class="market-label">Drawdown</div>
                <div class="market-value" id="o-dd">0%</div>
              </div>
              <div class="market-item">
                <div class="market-label">Mode</div>
                <div class="market-value" id="o-mode">PAPER</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-head"><span class="panel-label">Performance</span></div>
            <div class="panel-body">
              <div class="perf-row"><span class="perf-k">Best Trade</span><span class="perf-v c-green" id="o-best">$+0.00</span></div>
              <div class="perf-row"><span class="perf-k">Worst Trade</span><span class="perf-v c-red" id="o-worst">$+0.00</span></div>
              <div class="perf-row"><span class="perf-k">Win Streak</span><span class="perf-v" id="o-wstreak">0</span></div>
              <div class="perf-row"><span class="perf-k">Loss Streak</span><span class="perf-v" id="o-lstreak">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scan Stats -->
      <div class="panel">
        <div class="panel-head"><span class="panel-label">Scan Stats</span></div>
        <div class="panel-body" style="padding:0">
          <div class="scan-grid">
            <div class="scan-item"><div class="scan-label">Scanned</div><div class="scan-value c-white" id="sc-total">0</div></div>
            <div class="scan-item"><div class="scan-label">Signals</div><div class="scan-value c-blue" id="sc-signals">0</div></div>
            <div class="scan-item"><div class="scan-label">Regime Skip</div><div class="scan-value c-yellow" id="sc-regime">0</div></div>
            <div class="scan-item"><div class="scan-label">Corr. Skip</div><div class="scan-value c-yellow" id="sc-corr">0</div></div>
            <div class="scan-item"><div class="scan-label">AI Rejected</div><div class="scan-value c-red" id="sc-rejected">0</div></div>
            <div class="scan-item"><div class="scan-label">Approved</div><div class="scan-value c-green" id="sc-approved">0</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ══ POSITIONS ═════════════════════════════════════ -->
    <div id="page-positions" class="page">
      <div class="stats-row stats-3" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-label">Open Positions</div>
          <div class="stat-value" id="p-count">0/1</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unrealized PnL</div>
          <div class="stat-value" id="p-unreal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Leverage</div>
          <div class="stat-value c-yellow">20x</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><span class="panel-label">Active Positions</span></div>
        <table class="tbl">
          <thead>
            <tr><th>Symbol</th><th>Side</th><th>Entry</th><th>Current</th><th>PnL</th><th>PnL%</th><th>SL</th><th>TP</th><th>Progress</th><th>Status</th><th>Age</th></tr>
          </thead>
          <tbody id="p-body">
            <tr><td colspan="11" class="tbl-empty">No open positions</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ══ TRADES ═════════════════════════════════════════ -->
    <div id="page-trades" class="page">
      <div class="panel">
        <div class="panel-head">
          <span class="panel-label">Trade History</span>
          <span class="panel-badge" id="t-count">0</span>
        </div>
        <table class="tbl">
          <thead>
            <tr><th>Symbol</th><th>Side</th><th>Entry</th><th>Exit</th><th>P&L</th><th>Duration</th><th>Score</th><th>Exit Reason</th></tr>
          </thead>
          <tbody id="t-body">
            <tr><td colspan="8" class="tbl-empty">No trades</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ══ ANALYTICS ══════════════════════════════════════ -->
    <div id="page-analytics" class="page">
      <div class="grid-2" style="margin-bottom:16px">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Daily P&L (30 Days)</span></div>
          <div class="chart-wrap"><canvas id="dailyChart"></canvas></div>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Cumulative P&L</span></div>
          <div class="chart-wrap"><canvas id="cumulChart"></canvas></div>
        </div>
      </div>
      <div class="grid-2">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Monthly</span></div>
          <table class="tbl">
            <thead><tr><th>Month</th><th>Trades</th><th>Win Rate</th><th>P&L</th></tr></thead>
            <tbody id="monthly-body">
              <tr><td colspan="4" class="tbl-empty">No data</td></tr>
            </tbody>
          </table>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">By Symbol</span></div>
          <table class="tbl">
            <thead><tr><th>Symbol</th><th>Trades</th><th>Win Rate</th><th>P&L</th></tr></thead>
            <tbody id="symbol-body">
              <tr><td colspan="4" class="tbl-empty">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ══ AI ENGINE ══════════════════════════════════════ -->
    <div id="page-ai" class="page">
      <div class="stats-row stats-3" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-label">Signal Threshold</div>
          <div class="stat-value c-blue" id="ai-thresh">0.25</div>
          <div class="stat-sub">Adaptive</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Size Multiplier</div>
          <div class="stat-value c-blue" id="ai-mult">1.0x</div>
          <div class="stat-sub">Smart sizing</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Evaluations</div>
          <div class="stat-value" id="ai-evals">0</div>
          <div class="stat-sub">Auto self-eval</div>
        </div>
      </div>

      <div class="grid-2" style="margin-bottom:16px">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Active Features (9/9)</span></div>
          <div class="panel-body">
            <div class="chip-wrap">
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Auto Self-Evaluation</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Adaptive Threshold</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Market Regime Detection</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Smart Position Sizing</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Correlation Filter</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Circuit Breaker</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Trade Journal AI</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Pattern Recognition</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Auto Parameter Tuning</span>
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Safety Status</span></div>
          <div class="panel-body">
            <div class="safety-row"><span style="color:#888">Emergency Stop</span><span class="badge badge-neutral" id="ai-emg">INACTIVE</span></div>
            <div class="safety-row"><span style="color:#888">Daily Loss Limit</span><span class="badge badge-ok" id="ai-daily">OK</span></div>
            <div class="safety-row"><span style="color:#888">Drawdown Limit</span><span class="badge badge-ok" id="ai-dd">OK</span></div>
            <div class="safety-row"><span style="color:#888">Circuit Breaker</span><span class="badge badge-ok" id="ai-cb">OK</span></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <span class="panel-label">Market Analysis</span>
          <button class="btn btn-neutral" onclick="fetchAI()" id="ai-btn" style="padding:4px 12px;font-size:11px">Get Analysis</button>
        </div>
        <div class="panel-body">
          <div style="color:#555;font-size:13px;line-height:1.8" id="ai-resp">Click "Get Analysis" to fetch Claude AI market analysis...</div>
        </div>
      </div>
    </div>

    <!-- ══ JOURNAL ════════════════════════════════════════ -->
    <div id="page-journal" class="page">
      <div class="panel">
        <div class="panel-head"><span class="panel-label">Trade Journal — AI Analysis</span></div>
        <div class="panel-body" id="journal-body">
          <div style="color:#333;font-size:13px">No journal entries yet. Entries are written automatically after each trade closes.</div>
        </div>
      </div>
    </div>

    <!-- ══ TRANSACTIONS ═══════════════════════════════════ -->
    <div id="page-transactions" class="page">
      <div class="stats-row stats-3" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-label">Balance</div>
          <div class="stat-value" id="tx-bal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">This Month P&L</div>
          <div class="stat-value" id="tx-month">$+0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Trades</div>
          <div class="stat-value" id="tx-total">0</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head"><span class="panel-label">Transaction History</span></div>
        <table class="tbl">
          <thead>
            <tr><th>Date</th><th>Type</th><th>Symbol</th><th>Amount</th><th>Balance After</th><th>Note</th></tr>
          </thead>
          <tbody id="tx-body">
            <tr><td colspan="6" class="tbl-empty">No transactions</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ══ CONTROL ════════════════════════════════════════ -->
    <div id="page-control" class="page">
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-head"><span class="panel-label">Bot Control</span></div>
        <div class="panel-body">
          <div class="btn-row">
            <button class="btn btn-start" onclick="botCmd('start')">▶ Start Bot</button>
            <button class="btn btn-stop" onclick="botCmd('emergency-stop')">⬛ Stop Bot</button>
            <button class="btn btn-reset" onclick="botCmd('reset-daily')">↺ Reset Daily</button>
            <button class="btn btn-neutral" onclick="fetchAll()">⟳ Refresh</button>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Bot Status</span></div>
          <div class="panel-body">
            <div class="perf-row"><span class="perf-k">Mode</span><span class="perf-v" id="c-mode">—</span></div>
            <div class="perf-row"><span class="perf-k">Running</span><span class="perf-v" id="c-run">—</span></div>
            <div class="perf-row"><span class="perf-k">Balance</span><span class="perf-v c-white" id="c-bal">—</span></div>
            <div class="perf-row"><span class="perf-k">Positions</span><span class="perf-v" id="c-pos">0/1</span></div>
            <div class="perf-row"><span class="perf-k">Total Trades</span><span class="perf-v" id="c-trades">0</span></div>
            <div class="perf-row"><span class="perf-k">Last Update</span><span class="perf-v" id="c-upd">—</span></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Risk Config</span></div>
          <div class="panel-body">
            <div class="perf-row"><span class="perf-k">Daily Loss Limit</span><span class="perf-v">15%</span></div>
            <div class="perf-row"><span class="perf-k">Drawdown Limit</span><span class="perf-v">30%</span></div>
            <div class="perf-row"><span class="perf-k">SL ATR Multiplier</span><span class="perf-v">2.5×</span></div>
            <div class="perf-row"><span class="perf-k">TP Multiplier</span><span class="perf-v">1.8×</span></div>
            <div class="perf-row"><span class="perf-k">Max Positions</span><span class="perf-v">1</span></div>
            <div class="perf-row"><span class="perf-k">Risk per Trade</span><span class="perf-v">3%</span></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<script>
const API = '/api/proxy';
let prevTrades = [], charts = {}, txHistory = [], lastPositions = [];
let scanCounterDay = null, scanCounter = {scanned:0,signals:0,regime:0,corr:0,rejected:0,approved:0};

function getScanCounter() {
  var today = new Date().toDateString();
  if(scanCounterDay !== today) {
    scanCounterDay = today;
    scanCounter = {scanned:0,signals:0,regime:0,corr:0,rejected:0,approved:0};
    try { localStorage.setItem('scanDay', today); localStorage.setItem('scanData', JSON.stringify(scanCounter)); } catch(e) {}
  }
  return scanCounter;
}
function updateScanCounter(data) {
  var sc = getScanCounter();
  // Setiap fetchAll = 1 scan cycle
  if(data && data.count !== undefined) {
    sc.scanned = data.count||0;
    sc.signals = data.count||0;
    sc.approved = data.count||0;
  }
  try { localStorage.setItem('scanData', JSON.stringify(sc)); } catch(e) {}
  return sc;
}

// Clock
setInterval(() => {
  document.getElementById('tb-time').textContent = new Date().toTimeString().slice(0,8);
}, 1000);

// Nav
const titles = {overview:'Overview',positions:'Positions',trades:'Trades',analytics:'Analytics',ai:'AI Engine',journal:'Journal',transactions:'Transactions',control:'Control'};
function go(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  el.classList.add('active');
  document.getElementById('page-title').textContent = titles[page]||page;
  if(page==='analytics') renderAnalytics();
}

// API
async function api(path, method='GET') {
  const r = await fetch(`${API}?path=${path}`, {method});
  if(!r.ok) throw new Error(r.status);
  return r.json();
}

// Notify
function notify(title, body, type='info') {
  const s = document.getElementById('notifs');
  const n = document.createElement('div');
  n.className = `notif notif-${type}`;
  n.innerHTML = `<div class="n-title">${title}</div><div class="n-body">${body}</div>`;
  s.appendChild(n);
  setTimeout(() => n.remove(), 4000);
}

// Fetch all
async function fetchAll() {
  try {
    const [status, pos, trades, perf] = await Promise.all([
      api('status'), api('positions'), api('trades'), api('performance')
    ]);
    // Update positions dulu agar lastPositions terisi sebelum updateOverview
    updatePositions(pos, status);
    updateOverview(status, perf, trades, pos);
    updateTrades(trades);
    updateTransactions(trades, status);
    updateAI(status);
    updateControl(status, trades);
    document.getElementById('last-update').textContent = 'Updated: '+new Date().toTimeString().slice(0,5);
  } catch(e) {
    document.getElementById('bot-dot').className = 'status-dot off';
    document.getElementById('bot-status-text').textContent = 'Disconnected';
  }
}

function fmt(v, prefix='$') {
  const n = parseFloat(v)||0;
  return `${n>=0?prefix+'+':'-'+prefix}${Math.abs(n).toFixed(2)}`;
}

// OVERVIEW
function updateOverview(s, perf, tradesData, posData) {
  const b = s.balance||{}, p = s.performance||{}, sf = s.safety||{};
  // Ambil field dari tempat yang benar
  const bal = b.current||0;
  const tpnl = b.total_pnl||0;          // total_pnl ada di balance
  const dpnl = b.daily_pnl||0;          // daily_pnl ada di balance
  const wr = p.win_rate||0;
  const dd = p.current_drawdown||0;
  const sm = perf?.summary||{};
  const trades = tradesData?.trades||[];
  const posCount = posData?.positions?.length||0;

  // Balance realtime = closed balance + unrealized dari posisi terbuka
  const unrealTotal = lastPositions.reduce((s,p)=>s+(parseFloat(p.unrealized_pnl)||0), 0);
  const realtimeBal = bal + unrealTotal;
  document.getElementById('o-bal').textContent = `$${realtimeBal.toFixed(4)}`;
  
  // Today P&L = closed daily_pnl + unrealized saat ini
  const realtimeDpnl = dpnl + unrealTotal;
  const dp = document.getElementById('o-dpnl');
  dp.textContent = `${realtimeDpnl>=0?'$+':'$-'}${Math.abs(realtimeDpnl).toFixed(4)}`;
  dp.className = `stat-value ${realtimeDpnl>=0?'c-green':'c-red'}`;
  
  const tp = document.getElementById('o-tpnl');
  const realtimeTpnl = tpnl + unrealTotal;
  tp.textContent = `${realtimeTpnl>=0?'$+':'$-'}${Math.abs(realtimeTpnl).toFixed(4)}`;
  tp.className = `stat-value ${realtimeTpnl>=0?'c-green':'c-red'}`;
  const wrEl = document.getElementById('o-wr');
  wrEl.textContent = `${wr.toFixed(1)}%`;
  wrEl.className = `stat-value ${wr>=50?'c-green':wr>=40?'c-yellow':'c-red'}`;
  document.getElementById('o-trades').textContent = `${p.total_trades||0} trades`;
  document.getElementById('o-pos').textContent = posCount;
  document.getElementById('o-pos-badge').textContent = posCount;

  // Mode
  const mode = s.bot?.trading_mode||s.bot?.mode||'paper';
  document.getElementById('o-mode').textContent = mode.toUpperCase();
  document.getElementById('tb-mode').textContent = mode.toUpperCase();
  document.getElementById('tb-mode').className = mode==='live'?'c-green':'c-yellow';
  document.getElementById('o-dd').textContent = `${dd.toFixed(2)}%`;
  document.getElementById('o-dd').className = `market-value ${dd<15?'c-green':dd<25?'c-yellow':'c-red'}`;

  // Session (time-based)
  const h = new Date().getUTCHours();
  let session = 'ASIA';
  if(h>=8&&h<16) session='LONDON';
  else if(h>=13&&h<21) session='NY';
  else if(h>=8&&h<21) session='OVERLAP';
  document.getElementById('o-session').textContent = session;

  // Perf — hitung dari trades list
  const closedTrades = trades||[];
  const bestPnl = closedTrades.length ? Math.max(...closedTrades.map(t=>t.pnl||0)) : 0;
  const worstPnl = closedTrades.length ? Math.min(...closedTrades.map(t=>t.pnl||0)) : 0;
  const bestEl = document.getElementById('o-best');
  bestEl.textContent = `${bestPnl>=0?'$+':'$'}${bestPnl.toFixed(4)}`;
  bestEl.className = `perf-v ${bestPnl>=0?'c-green':'c-red'}`;
  const worstEl = document.getElementById('o-worst');
  worstEl.textContent = `${worstPnl>=0?'$+':'$'}${worstPnl.toFixed(4)}`;
  worstEl.className = `perf-v ${worstPnl>=0?'c-green':'c-red'}`;
  document.getElementById('o-wstreak').textContent = p.winning_trades||0;
  document.getElementById('o-lstreak').textContent = p.losing_trades||0;

  // Positions table in overview — diisi dari updatePositions via lastPositions
  renderOverviewPositions(lastPositions);

  // Bot status — realtime
  const running = s.bot?.is_running;
  document.getElementById('bot-dot').className = `status-dot ${running?'':'off'}`;
  document.getElementById('bot-status-text').textContent = running?'Bot Running':'Bot Stopped';
  // Update topbar balance realtime (termasuk unrealized)
  document.getElementById('tb-bal') && (document.getElementById('tb-bal').textContent = `$${realtimeBal.toFixed(4)}`);

  // Scan stats — ambil dari state.scan_stats jika ada
  const scanStats = s.scan_stats || s.today_stats || {};
  const todayTrades = p.total_trades || 0;
  document.getElementById('sc-total').textContent = scanStats.total_scanned || scanStats.scanned || todayTrades;
  document.getElementById('sc-signals').textContent = scanStats.signals_found || scanStats.signals || todayTrades;
  document.getElementById('sc-regime').textContent = scanStats.regime_skip || scanStats.regime_skipped || 0;
  document.getElementById('sc-corr').textContent = scanStats.corr_skip || scanStats.correlation_skip || 0;
  document.getElementById('sc-rejected').textContent = scanStats.ai_rejected || scanStats.rejected || 0;
  document.getElementById('sc-approved').textContent = scanStats.approved || todayTrades;
}

// RENDER OVERVIEW POSITIONS (dengan current price realtime + progress bar)
function renderOverviewPositions(pos) {
  const ob = document.getElementById('o-pos-body');
  if(!pos||!pos.length) {
    ob.innerHTML=`<tr><td colspan="7" class="tbl-empty">No open positions</td></tr>`;
    return;
  }
  window._posCache = pos;
  ob.innerHTML = pos.map((p, i) => {
    const pnl = p.unrealized_pnl||0;
    const entry = parseFloat(p.entry_price||0);
    const cur = parseFloat(p.current_price||entry);
    const sl = parseFloat(p.stop_loss||0);
    const tp = parseFloat(p.take_profit||0);
    const beDone = p.be_done||false;
    const trailSL = parseFloat(p.trailing_sl||0);
    const side = p.side==='Buy'?'LONG':'SHORT';

    // Progress bar: 0% = entry, 100% = TP
    // Gunakan unrealized_pnl_pct (sudah leverage-adjusted dari API)
    const rawPct = parseFloat(p.unrealized_pnl_pct||0); // leverage-adjusted %
    // Normalize ke range SL→TP (SL = -100%, TP = +100%)
    // rawPct bisa -X% sampai +Y%, kita map ke 0-100% progress menuju TP
    let pct = 0, barColor = '#3b82f6', statusLabel = 'Active';
    if(entry && tp && sl) {
      const slDist = Math.abs(entry - sl);       // jarak ke SL
      const tpDist = Math.abs(tp - entry);       // jarak ke TP
      const totalRange = slDist + tpDist;
      const curMove = side==='LONG' ? (cur - entry) : (entry - cur);
      // pct = 0% di SL, 50% di entry, 100% di TP
      const rawProgress = (curMove + slDist) / totalRange;
      pct = Math.max(0, Math.min(100, rawProgress * 100));
      if(beDone) { barColor='#eab308'; statusLabel='BE'; }
      else if(trailSL > 0) { barColor='#3b82f6'; statusLabel='Trailing'; }
      else if(curMove < 0) { barColor='#ef4444'; statusLabel='In Loss'; }
      else { barColor='#22c55e'; statusLabel='Profit'; }
    }

    return `<tr style="cursor:pointer;transition:background 0.1s" onclick="openPosModal(window._posCache&&window._posCache[${i}])" onmouseenter="this.style.background='#161616'" onmouseleave="this.style.background=''">
      <td style="font-weight:500">${p.symbol}</td>
      <td><span class="badge ${p.side==='Buy'?'badge-long':'badge-short'}">${side}</span></td>
      <td>${entry.toFixed(4)}</td>
      <td style="font-family:monospace">${cur.toFixed(4)}</td>
      <td class="${pnl>=0?'c-green':'c-red'}">${pnl>=0?'+':''}$${pnl.toFixed(4)}</td>
      <td style="min-width:100px">
        <div style="display:flex;align-items:center;gap:6px">
          <div style="flex:1;height:4px;background:#1a1a1a;border-radius:2px;overflow:hidden">
            <div style="width:${Math.max(0,pct).toFixed(1)}%;height:100%;background:${barColor};border-radius:2px;transition:width 0.5s"></div>
          </div>
          <span style="font-size:9px;color:${barColor};white-space:nowrap;min-width:40px;text-align:right">${statusLabel||pct.toFixed(1)+'%'}</span>
        </div>
      </td>
      <td class="c-gray">${getAge(p.opened_at)}</td>
    </tr>`;
  }).join('');
}

// POSITIONS
function updatePositions(data, status) {
  const pos = data.positions||[];
  lastPositions = pos;
  renderOverviewPositions(pos);
  const unreal = pos.reduce((s,p)=>s+(p.unrealized_pnl||0),0);
  document.getElementById('p-count').textContent = `${pos.length}/1`;
  const ur = document.getElementById('p-unreal');
  ur.textContent = `$${unreal.toFixed(4)}`;
  ur.className = `stat-value ${unreal>=0?'c-green':'c-red'}`;

  const body = document.getElementById('p-body');
  if(!pos.length) { body.innerHTML=`<tr><td colspan="11" class="tbl-empty">No open positions</td></tr>`; return; }
  body.innerHTML = pos.map((p, i) => {
    const pnl = p.unrealized_pnl||0;
    const entry = parseFloat(p.entry_price||0);
    const cur = parseFloat(p.current_price||entry);
    const sl = parseFloat(p.stop_loss||0);
    const tp = parseFloat(p.take_profit||0);
    const beDone = p.be_done||false;
    const trailSL = parseFloat(p.trailing_sl||0);
    const side = p.side==='Buy'?'LONG':'SHORT';
    const pnlPct = entry?((cur-entry)/entry*100*(p.side==='Buy'?1:-1)).toFixed(2):'0.00';

    let pct=0, barColor='#3b82f6', statusLabel='Active';
    if(entry && tp && sl) {
      const slDist = Math.abs(entry-sl);
      const tpDist = Math.abs(tp-entry);
      const totalRange = slDist + tpDist;
      const curMove = side==='LONG'?(cur-entry):(entry-cur);
      const rawProgress = (curMove + slDist) / totalRange;
      pct = Math.max(0, Math.min(100, rawProgress*100));
      if(trailSL>0){barColor='#3b82f6';statusLabel='Trailing';}
      else if(beDone){barColor='#eab308';statusLabel='Break-Even';}
      else if(curMove<0){barColor='#ef4444';statusLabel='In Loss';}
      else{barColor='#22c55e';statusLabel='Profit';}
    }
    return `<tr style="cursor:pointer;transition:background 0.1s" onclick="openPosModal(window._posCache&&window._posCache[${i}])" onmouseenter="this.style.background='#161616'" onmouseleave="this.style.background=''">
      <td style="font-weight:500">${p.symbol}</td>
      <td><span class="badge ${p.side==='Buy'?'badge-long':'badge-short'}">${side}</span></td>
      <td>${entry.toFixed(4)}</td>
      <td style="font-family:monospace">${cur.toFixed(4)}</td>
      <td class="${pnl>=0?'c-green':'c-red'}">${pnl>=0?'+':''}$${pnl.toFixed(4)}</td>
      <td class="${pnl>=0?'c-green':'c-red'}">${pnlPct}%</td>
      <td class="c-gray">${sl.toFixed(4)}</td>
      <td class="c-gray">${tp.toFixed(4)}</td>
      <td style="min-width:100px">
        <div style="height:4px;background:#1a1a1a;border-radius:2px;overflow:hidden;position:relative">
          <div style="position:absolute;left:${pct<0?Math.max(0,50+pct/2)+'%':'0'};width:${Math.abs(pct).toFixed(1)}%;height:100%;background:${barColor};border-radius:2px;transition:all 0.5s;max-width:100%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:3px">
          <span style="font-size:9px;color:${barColor}">${pct>=0?'+':''}${pct.toFixed(1)}%</span>
          <span style="font-size:9px;color:${barColor}">${statusLabel}</span>
        </div>
      </td>
      <td></td>
      <td class="c-gray">${getAge(p.opened_at)}</td>
    </tr>`;
  }).join('');
}

// TRADES
function updateTrades(data) {
  const trades = data.trades||[];
  if(prevTrades.length && trades.length>prevTrades.length) {
    const t = trades[0];
    if(t.pnl>=0) notify('Trade WIN ✓', `${t.symbol} +$${t.pnl.toFixed(2)}`, 'win');
    else notify('Trade LOSS', `${t.symbol} $${t.pnl.toFixed(2)}`, 'loss');
  }
  prevTrades = trades;
  document.getElementById('t-count').textContent = trades.length;
  const body = document.getElementById('t-body');
  if(!trades.length) { body.innerHTML=`<tr><td colspan="8" class="tbl-empty">No trades</td></tr>`; return; }
  body.innerHTML = trades.map(t => {
    const pnl = t.pnl||0, dur = getDur(t.opened_at,t.closed_at);
    return `<tr>
      <td style="font-weight:500">${t.symbol}</td>
      <td><span class="badge ${t.side==='Buy'?'badge-long':'badge-short'}">${t.side==='Buy'?'LONG':'SHORT'}</span></td>
      <td>${(t.entry_price||0).toFixed(4)}</td><td>${(t.exit_price||0).toFixed(4)}</td>
      <td class="${pnl>=0?'c-green':'c-red'}" style="font-weight:500">${pnl>=0?'+':''}$${pnl.toFixed(4)}</td>
      <td class="c-gray">${dur}</td>
      <td class="c-gray">${(t.signal_score||0).toFixed(3)}</td>
      <td class="c-gray">${t.notes||'—'}</td>
    </tr>`;
  }).join('');
}

// TRANSACTIONS — deposit/withdraw/trade history
function updateTransactions(data, status) {
  const trades = data.trades||[];
  const bal = status.balance?.current||0;
  const initBal = status.balance?.initial||bal;
  const txUnreal = lastPositions.reduce((s,p)=>s+(parseFloat(p.unrealized_pnl)||0), 0);
  document.getElementById('tx-bal').textContent = `$${(bal+txUnreal).toFixed(4)}`;
  document.getElementById('tx-total').textContent = trades.length;

  // This Month P&L — total dari semua trades bulan ini
  const now = new Date();
  const thisMonthTrades = trades.filter(t => {
    if(!t.closed_at) return false;
    const d = new Date(t.closed_at);
    return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
  });
  const monthPnl = thisMonthTrades.reduce((s,t)=>s+(t.pnl||0),0);
  const mp = document.getElementById('tx-month');
  mp.textContent = `${monthPnl>=0?'$+':'$-'}${Math.abs(monthPnl).toFixed(4)}`;
  mp.className = `stat-value ${monthPnl>=0?'c-green':'c-red'}`;

  const body = document.getElementById('tx-body');
  if(!trades.length) { body.innerHTML=`<tr><td colspan="6" class="tbl-empty">No transactions</td></tr>`; return; }

  // Hitung balance after per trade (dari oldest ke newest)
  const sorted = [...trades].reverse();
  let runBal = initBal;
  const balAfter = {};
  sorted.forEach(t => {
    runBal += (t.pnl||0);
    balAfter[t.id||t.opened_at] = runBal;
  });

  body.innerHTML = trades.map(t => {
    const pnl = t.pnl||0;
    const isWin = pnl >= 0;
    const exitReason = t.notes||'—';
    const exitLabel = exitReason==='trailing_stop'?'Trailing Stop':
                      exitReason==='breakeven'?'Break-Even':
                      exitReason==='tp_hit'?'Take Profit':
                      exitReason==='sl_hit'?'Stop Loss':exitReason;
    const type = isWin?'Trade WIN':'Trade LOSS';
    const cls = isWin?'c-green':'c-red';
    const date = t.closed_at?new Date(t.closed_at).toLocaleString('id-ID',{dateStyle:'short',timeStyle:'short'}):'—';
    const balA = balAfter[t.id||t.opened_at];
    return `<tr>
      <td class="c-gray">${date}</td>
      <td class="${cls}" style="font-weight:500">${type}</td>
      <td style="font-weight:500">${t.symbol}</td>
      <td class="${cls}" style="font-weight:500">${pnl>=0?'+':''}$${pnl.toFixed(4)}</td>
      <td class="c-gray">$${balA?balA.toFixed(4):'—'}</td>
      <td class="c-gray" style="font-size:11px">${exitLabel}</td>
    </tr>`;
  }).join('');
}

// ANALYTICS
function renderAnalytics() {
  const trades = prevTrades;
  // Cumul chart
  let cumul = 0;
  const cumulData = trades.map(t => { cumul+=(t.pnl||0); return cumul; });
  const ctx = document.getElementById('cumulChart');
  if(ctx && trades.length) {
    if(charts.cumul) charts.cumul.destroy();
    charts.cumul = new Chart(ctx, {
      type:'line',
      data:{labels:trades.map((_,i)=>`#${i+1}`),datasets:[{
        data:cumulData,
        borderColor:'#22c55e',backgroundColor:'rgba(34,197,94,0.05)',
        borderWidth:1.5,fill:true,tension:0.3,pointRadius:0
      }]},
      options:{responsive:true,maintainAspectRatio:false,
        scales:{x:{ticks:{color:'#333',font:{size:9}},grid:{display:false}},
          y:{grid:{color:'#1a1a1a'},ticks:{color:'#444',font:{size:9},callback:v=>`$${v.toFixed(2)}`}}},
        plugins:{legend:{display:false}},animation:false}
    });
  }
  // Daily bar
  const ctx2 = document.getElementById('dailyChart');
  if(ctx2 && trades.length) {
    if(charts.daily) charts.daily.destroy();
    charts.daily = new Chart(ctx2, {
      type:'bar',
      data:{labels:trades.map((_,i)=>`#${i+1}`),datasets:[{
        data:trades.map(t=>t.pnl||0),
        backgroundColor:trades.map(t=>(t.pnl||0)>=0?'rgba(34,197,94,0.5)':'rgba(239,68,68,0.5)'),
        borderColor:trades.map(t=>(t.pnl||0)>=0?'#22c55e':'#ef4444'),
        borderWidth:1,borderRadius:2
      }]},
      options:{responsive:true,maintainAspectRatio:false,
        scales:{x:{ticks:{color:'#333',font:{size:9}},grid:{display:false}},
          y:{grid:{color:'#1a1a1a'},ticks:{color:'#444',font:{size:9},callback:v=>`$${v.toFixed(2)}`}}},
        plugins:{legend:{display:false}},animation:false}
    });
  }
  // By symbol
  const syms = {};
  trades.forEach(t => {
    if(!syms[t.symbol]) syms[t.symbol] = {trades:0,wins:0,pnl:0};
    syms[t.symbol].trades++;
    if(t.pnl>0) syms[t.symbol].wins++;
    syms[t.symbol].pnl += t.pnl||0;
  });
  const sb = document.getElementById('symbol-body');
  const entries = Object.entries(syms);
  if(!entries.length) { sb.innerHTML=`<tr><td colspan="4" class="tbl-empty">No data</td></tr>`; }
  else sb.innerHTML = entries.sort((a,b)=>b[1].pnl-a[1].pnl).map(([sym,d])=>`<tr>
    <td style="font-weight:500">${sym}</td>
    <td>${d.trades}</td>
    <td class="${(d.wins/d.trades)>=0.5?'c-green':'c-red'}">${((d.wins/d.trades)*100).toFixed(0)}%</td>
    <td class="${d.pnl>=0?'c-green':'c-red'}">${d.pnl>=0?'+':''}$${d.pnl.toFixed(4)}</td>
  </tr>`).join('');
}

// AI
function updateAI(s) {
  const sf = s.safety||{};
  setSafety('ai-emg', !sf.emergency_stop, sf.emergency_stop?'ACTIVE':'INACTIVE');
  setSafety('ai-daily', !sf.daily_loss_hit, sf.daily_loss_hit?'HIT':'OK');
  setSafety('ai-dd', !sf.drawdown_limit_hit, sf.drawdown_limit_hit?'HIT':'OK');
}
function setSafety(id, ok, label) {
  const el = document.getElementById(id);
  el.textContent = label;
  el.className = `badge ${ok?'badge-ok':'badge-hit'}`;
}
async function fetchAI() {
  const btn = document.getElementById('ai-btn');
  btn.textContent = 'Analyzing...'; btn.disabled = true;
  try {
    const d = await api('ai/market-analysis');
    document.getElementById('ai-resp').textContent = d.analysis||d.message||'No analysis available';
  } catch(e) {
    document.getElementById('ai-resp').textContent = 'Error: '+e.message;
  }
  btn.textContent = 'Get Analysis'; btn.disabled = false;
}

// CONTROL
function updateControl(s, tradesData) {
  const mode = s.bot?.trading_mode||s.bot?.mode||'paper';
  document.getElementById('c-mode').textContent = mode.toUpperCase();
  const isRun = s.bot?.is_running;
  document.getElementById('c-run').textContent = isRun ? '● ON' : '○ OFF';
  document.getElementById('c-run').className = `perf-v ${isRun?'c-green':'c-red'}`;
  const ctrlUnreal = lastPositions.reduce((s,p)=>s+(parseFloat(p.unrealized_pnl)||0), 0);
  document.getElementById('c-bal').textContent = `$${((s.balance?.current||0)+ctrlUnreal).toFixed(4)}`;
  document.getElementById('c-pos').textContent = `${lastPositions.length}/1`;
  document.getElementById('c-trades').textContent = s.performance?.total_trades||0;
  document.getElementById('c-upd').textContent = new Date().toTimeString().slice(0,8);
  document.getElementById('c-mode').textContent = (s.bot?.trading_mode||s.bot?.mode||'paper').toUpperCase();
}

async function botCmd(action) {
  try {
    const opts = {method:'POST', headers:{'Content-Type':'application/json'}};
    if(action==='emergency-stop') opts.body = JSON.stringify({reason:'Manual stop via dashboard'});
    const r = await fetch(`${API}?path=${action}`, opts);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const labels = {'start':'Bot started ▶','emergency-stop':'Bot stopped ⬛','reset-daily':'Daily stats reset ↺'};
    notify(labels[action]||action, '', action==='emergency-stop'?'loss':'info');
    setTimeout(fetchAll, 1500);
  } catch(e) { notify('Error: '+action, e.message, 'loss'); }
}

// HELPERS
function getAge(iso) {
  if(!iso) return '—';
  const d=(Date.now()-new Date(iso).getTime())/1000;
  if(d<60) return `${Math.floor(d)}s`;
  if(d<3600) return `${Math.floor(d/60)}m`;
  return `${Math.floor(d/3600)}h`;
}
function getDur(a,b) {
  if(!a||!b) return '—';
  const d=(new Date(b)-new Date(a))/1000;
  if(d<60) return `${Math.floor(d)}s`;
  if(d<3600) return `${Math.floor(d/60)}m`;
  return `${Math.floor(d/3600)}h`;
}

fetchAll();
setInterval(fetchAll, 30000);

// Anti-copy
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if((e.ctrlKey||e.metaKey) && ['c','a','s','u','p'].includes(e.key.toLowerCase())) e.preventDefault();
});

// Modal functions
function openPosModal(pos) {
  var side = pos.side==='Buy'?'LONG':'SHORT';
  var badgeClass = pos.side==='Buy'?'badge-long':'badge-short';
  var pnl = pos.unrealized_pnl||0;
  var entry = parseFloat(pos.entry_price||0);
  var cur = parseFloat(pos.current_price||entry);
  var sl = parseFloat(pos.stop_loss||0);
  var tp = parseFloat(pos.take_profit||0);
  var trailSL = parseFloat(pos.trailing_sl||0);
  var pnlPct = pos.unrealized_pnl_pct||0;
  var status = trailSL>0?'Trailing Stop':(pos.be_done?'Break-Even':'Active');
  var pnlClass = pnl>=0?'c-green':'c-red';
  var pnlSign = pnl>=0?'+':'';
  var openedStr = pos.opened_at ? new Date(pos.opened_at).toLocaleString('id-ID') : '-';
  var trailStr = trailSL>0 ? trailSL.toFixed(6) : '-';

  document.getElementById('modal-symbol').innerHTML =
    pos.symbol + ' <span class="badge ' + badgeClass + '" style="margin-left:8px">' + side + '</span>';

  function row(k, v, cls) {
    return '<div class="modal-row"><span class="modal-k">' + k + '</span><span class="modal-v ' + (cls||'') + '">' + v + '</span></div>';
  }

  document.getElementById('modal-body').innerHTML =
    row('Strategy', pos.strategy||'-', '') +
    row('Entry Price', entry.toFixed(6)) +
    row('Current Price', cur.toFixed(6)) +
    row('Quantity', (pos.quantity||0).toFixed(2)) +
    row('Leverage', (pos.leverage||1) + 'x', 'c-yellow') +
    row('Margin Used', '$' + (pos.margin||0).toFixed(4)) +
    row('Unrealized PnL', pnlSign + '$' + pnl.toFixed(4) + ' (' + pnlPct.toFixed(2) + '%)', pnlClass) +
    row('Stop Loss', sl.toFixed(6), 'c-red') +
    row('Take Profit', tp.toFixed(6), 'c-green') +
    row('Trailing SL', trailStr, 'c-blue') +
    row('Signal Score', (pos.signal_score||0).toFixed(3)) +
    row('Status', status) +
    row('Opened', openedStr, 'c-gray') +
    row('Age', getAge(pos.opened_at));

  document.getElementById('pos-modal').classList.add('open');
}

function closeModal() {
  document.getElementById('pos-modal').classList.remove('open');
}
</script>

<!-- POSITION DETAIL MODAL -->
<div class="modal-overlay" id="pos-modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title" id="modal-symbol">Position Detail</span>
      <span class="modal-close" onclick="closeModal()">×</span>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>
</body>
</html>
