<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; }
body {
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  background: #0a0a0a;
  color: #e0e0e0;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ── SIDEBAR ─────────────────────────── */
.sidebar {
  width: 160px;
  background: #0a0a0a;
  border-right: 1px solid #1a1a1a;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  padding: 20px 0;
}
.sidebar-brand {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 2px;
  color: #555;
  padding: 0 20px 24px;
  text-transform: uppercase;
}
.nav-item {
  padding: 9px 20px;
  font-size: 13px;
  color: #555;
  cursor: pointer;
  transition: color 0.15s;
  user-select: none;
}
.nav-item:hover { color: #aaa; }
.nav-item.active { color: #fff; font-weight: 500; }
.sidebar-footer {
  margin-top: auto;
  padding: 16px 20px;
  border-top: 1px solid #1a1a1a;
  font-size: 11px;
}
.bot-status {
  display: flex;
  align-items: center;
  gap: 7px;
  margin-bottom: 6px;
}
.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #22c55e;
  flex-shrink: 0;
}
.status-dot.off { background: #ef4444; }
.status-text { color: #555; }
.last-update { color: #333; font-size: 10px; }

/* ── MAIN ────────────────────────────── */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.topbar {
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  border-bottom: 1px solid #1a1a1a;
  flex-shrink: 0;
}
.page-title {
  font-size: 16px;
  font-weight: 500;
  color: #fff;
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 12px;
  color: #555;
}
.topbar-right span { cursor: pointer; }
.topbar-right span:hover { color: #aaa; }

.content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}
.content::-webkit-scrollbar { width: 4px; }
.content::-webkit-scrollbar-thumb { background: #1a1a1a; }

/* ── PAGES ───────────────────────────── */
.page { display: none; }
.page.active { display: block; }

/* ── STAT CARDS ──────────────────────── */
.stats-row {
  display: grid;
  gap: 12px;
  margin-bottom: 16px;
}
.stats-5 { grid-template-columns: repeat(5, 1fr); }
.stats-3 { grid-template-columns: repeat(3, 1fr); }
.stats-2 { grid-template-columns: repeat(2, 1fr); }
.stat-card {
  background: #111;
  border: 1px solid #1a1a1a;
  border-radius: 8px;
  padding: 16px 18px;
}
.stat-label {
  font-size: 11px;
  color: #555;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.stat-value {
  font-size: 22px;
  font-weight: 500;
  color: #fff;
  line-height: 1;
  margin-bottom: 4px;
}
.stat-sub { font-size: 11px; color: #444; }
.c-green { color: #22c55e !important; }
.c-red { color: #ef4444 !important; }
.c-blue { color: #3b82f6 !important; }
.c-yellow { color: #eab308 !important; }
.c-gray { color: #555 !important; }
.c-white { color: #fff !important; }

/* ── PANEL ───────────────────────────── */
.panel {
  background: #111;
  border: 1px solid #1a1a1a;
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}
.panel-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 18px;
  border-bottom: 1px solid #1a1a1a;
}
.panel-label {
  font-size: 11px;
  font-weight: 500;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.panel-badge {
  font-size: 11px;
  background: #1a1a1a;
  color: #555;
  padding: 2px 8px;
  border-radius: 4px;
}
.panel-body { padding: 18px; }

/* ── GRID LAYOUT ─────────────────────── */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }

/* ── TABLE ───────────────────────────── */
.tbl { width: 100%; border-collapse: collapse; }
.tbl th {
  padding: 10px 18px;
  text-align: left;
  font-size: 11px;
  color: #444;
  font-weight: 400;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid #1a1a1a;
}
.tbl td {
  padding: 11px 18px;
  border-bottom: 1px solid #141414;
  font-size: 13px;
  color: #ccc;
}
.tbl tr:last-child td { border-bottom: none; }
.tbl tr:hover td { background: #131313; }
.tbl-empty {
  padding: 40px;
  text-align: center;
  color: #333;
  font-size: 13px;
}

/* ── BADGES ──────────────────────────── */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
}
.badge-long { background: rgba(34,197,94,0.1); color: #22c55e; }
.badge-short { background: rgba(239,68,68,0.1); color: #ef4444; }
.badge-ok { background: rgba(34,197,94,0.1); color: #22c55e; }
.badge-hit { background: rgba(239,68,68,0.1); color: #ef4444; }
.badge-neutral { background: #1a1a1a; color: #555; }

/* ── PERFORMANCE ROW ─────────────────── */
.perf-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 9px 0;
  border-bottom: 1px solid #141414;
  font-size: 13px;
}
.perf-row:last-child { border-bottom: none; }
.perf-k { color: #555; }
.perf-v { color: #ccc; font-weight: 500; }

/* ── SAFETY ROW ──────────────────────── */
.safety-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 9px 0;
  border-bottom: 1px solid #141414;
}
.safety-row:last-child { border-bottom: none; }

/* ── CHART ───────────────────────────── */
.chart-wrap { padding: 8px 4px; position: relative; }
.chart-wrap canvas { max-height: 200px; }

/* ── PROGRESS ────────────────────────── */
.progress {
  height: 3px;
  background: #1a1a1a;
  border-radius: 2px;
  overflow: hidden;
  margin: 6px 0 3px;
}
.progress-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.4s;
}
.pf-green { background: #22c55e; }
.pf-gradient { background: linear-gradient(90deg,#22c55e,#eab308,#ef4444); }

/* ── CONTROL BUTTONS ─────────────────── */
.btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
.btn {
  padding: 8px 16px;
  border-radius: 6px;
  border: 1px solid;
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-start { border-color: #22c55e; color: #22c55e; background: rgba(34,197,94,0.06); }
.btn-start:hover { background: #22c55e; color: #000; }
.btn-stop { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,0.06); }
.btn-stop:hover { background: #ef4444; color: #fff; }
.btn-reset { border-color: #3b82f6; color: #3b82f6; background: rgba(59,130,246,0.06); }
.btn-reset:hover { background: #3b82f6; color: #fff; }
.btn-neutral { border-color: #333; color: #666; background: transparent; }
.btn-neutral:hover { border-color: #555; color: #aaa; }

/* ── SCAN STATS ──────────────────────── */
.scan-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 1px;
  background: #1a1a1a;
  border-radius: 6px;
  overflow: hidden;
}
.scan-item {
  background: #111;
  padding: 14px 12px;
  text-align: center;
}
.scan-label { font-size: 10px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.scan-value { font-size: 18px; font-weight: 500; }

/* ── MARKET ──────────────────────────── */
.market-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #1a1a1a; }
.market-item { background: #111; padding: 14px 18px; }
.market-label { font-size: 10px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.market-value { font-size: 16px; font-weight: 500; color: #fff; }
.market-sub { font-size: 11px; color: #444; margin-top: 2px; }

/* ── NOTIF ───────────────────────────── */
.notif-stack {
  position: fixed;
  bottom: 16px; right: 16px;
  z-index: 999;
  display: flex;
  flex-direction: column-reverse;
  gap: 6px;
}
.notif {
  background: #111;
  border: 1px solid #222;
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 12px;
  min-width: 220px;
  animation: slideUp 0.2s ease;
}
@keyframes slideUp { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.notif-win { border-left: 2px solid #22c55e; }
.notif-loss { border-left: 2px solid #ef4444; }
.notif-info { border-left: 2px solid #3b82f6; }
.n-title { font-weight: 500; margin-bottom: 2px; }
.n-body { color: #555; font-size: 11px; }

/* ── AI CHIPS ────────────────────────── */
.chip-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
.chip {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 4px;
  background: #1a1a1a;
  color: #555;
  border: 1px solid #222;
}

/* ── JOURNAL ─────────────────────────── */
.journal-entry {
  padding: 14px 0;
  border-bottom: 1px solid #1a1a1a;
}
.journal-entry:last-child { border-bottom: none; }
.journal-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
  font-size: 12px;
}
.journal-body { font-size: 12px; color: #666; line-height: 1.7; }

/* ── TRANSACTION TYPE ────────────────── */
.tx-deposit { color: #22c55e; }
.tx-withdraw { color: #ef4444; }
.tx-trade { color: #3b82f6; }
</style>
</head>
<body>

<div class="notif-stack" id="notifs"></div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-brand">Dashboard</div>
  <div class="nav-item active" onclick="go('overview',this)">Overview</div>
  <div class="nav-item" onclick="go('positions',this)">Positions</div>
  <div class="nav-item" onclick="go('trades',this)">Trades</div>
  <div class="nav-item" onclick="go('analytics',this)">Analytics</div>
  <div class="nav-item" onclick="go('ai',this)">AI Engine</div>
  <div class="nav-item" onclick="go('journal',this)">Journal</div>
  <div class="nav-item" onclick="go('transactions',this)">Transactions</div>
  <div class="nav-item" onclick="go('control',this)">Control</div>

  <div class="sidebar-footer">
    <div class="bot-status">
      <div class="status-dot" id="bot-dot"></div>
      <span class="status-text" id="bot-status-text">Bot Running</span>
    </div>
    <div class="last-update" id="last-update">Updated: --:--</div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="page-title" id="page-title">Overview</div>
    <div class="topbar-right">
      <span id="tb-mode" style="color:#eab308">PAPER</span>
      <span id="tb-time">--:--:--</span>
      <span onclick="go('control',document.querySelector('.nav-item:last-child'))" style="color:#333">admin</span>
    </div>
  </div>

  <div class="content">

    <!-- ══ OVERVIEW ══════════════════════════════════════ -->
    <div id="page-overview" class="page active">
      <div class="stats-row stats-5">
        <div class="stat-card">
          <div class="stat-label">Balance</div>
          <div class="stat-value" id="o-bal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Today P&L</div>
          <div class="stat-value c-green" id="o-dpnl">$+0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total P&L</div>
          <div class="stat-value c-green" id="o-tpnl">$+0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Win Rate</div>
          <div class="stat-value" id="o-wr">0%</div>
          <div class="stat-sub" id="o-trades">0 trades</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Positions</div>
          <div class="stat-value" id="o-pos">0</div>
        </div>
      </div>

      <div class="grid-2-1" style="margin-bottom:16px">
        <!-- Active Positions -->
        <div class="panel">
          <div class="panel-head">
            <span class="panel-label">Active Positions</span>
            <span class="panel-badge" id="o-pos-badge">0</span>
          </div>
          <table class="tbl">
            <thead>
              <tr><th>Symbol</th><th>Side</th><th>Entry</th><th>PnL</th><th>SL</th><th>Age</th></tr>
            </thead>
            <tbody id="o-pos-body">
              <tr><td colspan="6" class="tbl-empty">No open positions</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Right column -->
        <div>
          <div class="panel" style="margin-bottom:16px">
            <div class="panel-head"><span class="panel-label">Market</span></div>
            <div class="market-grid">
              <div class="market-item">
                <div class="market-label">Session</div>
                <div class="market-value" id="o-session">—</div>
              </div>
              <div class="market-item">
                <div class="market-label">Drawdown</div>
                <div class="market-value" id="o-dd">0%</div>
              </div>
              <div class="market-item">
                <div class="market-label">Mode</div>
                <div class="market-value" id="o-mode">PAPER</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-head"><span class="panel-label">Performance</span></div>
            <div class="panel-body">
              <div class="perf-row"><span class="perf-k">Best Trade</span><span class="perf-v c-green" id="o-best">$+0.00</span></div>
              <div class="perf-row"><span class="perf-k">Worst Trade</span><span class="perf-v c-red" id="o-worst">$+0.00</span></div>
              <div class="perf-row"><span class="perf-k">Win Streak</span><span class="perf-v" id="o-wstreak">0</span></div>
              <div class="perf-row"><span class="perf-k">Loss Streak</span><span class="perf-v" id="o-lstreak">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scan Stats -->
      <div class="panel">
        <div class="panel-head"><span class="panel-label">Scan Stats</span></div>
        <div class="panel-body" style="padding:0">
          <div class="scan-grid">
            <div class="scan-item"><div class="scan-label">Scanned</div><div class="scan-value c-white" id="sc-total">0</div></div>
            <div class="scan-item"><div class="scan-label">Signals</div><div class="scan-value c-blue" id="sc-signals">0</div></div>
            <div class="scan-item"><div class="scan-label">Regime Skip</div><div class="scan-value c-yellow" id="sc-regime">0</div></div>
            <div class="scan-item"><div class="scan-label">Corr. Skip</div><div class="scan-value c-yellow" id="sc-corr">0</div></div>
            <div class="scan-item"><div class="scan-label">AI Rejected</div><div class="scan-value c-red" id="sc-rejected">0</div></div>
            <div class="scan-item"><div class="scan-label">Approved</div><div class="scan-value c-green" id="sc-approved">0</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ══ POSITIONS ═════════════════════════════════════ -->
    <div id="page-positions" class="page">
      <div class="stats-row stats-3" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-label">Open Positions</div>
          <div class="stat-value" id="p-count">0/1</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unrealized PnL</div>
          <div class="stat-value" id="p-unreal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Leverage</div>
          <div class="stat-value c-yellow">20x</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><span class="panel-label">Active Positions</span></div>
        <table class="tbl">
          <thead>
            <tr><th>Symbol</th><th>Side</th><th>Entry</th><th>Current</th><th>PnL</th><th>PnL%</th><th>Stop Loss</th><th>Take Profit</th><th>Age</th></tr>
          </thead>
          <tbody id="p-body">
            <tr><td colspan="9" class="tbl-empty">No open positions</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ══ TRADES ═════════════════════════════════════════ -->
    <div id="page-trades" class="page">
      <div class="panel">
        <div class="panel-head">
          <span class="panel-label">Trade History</span>
          <span class="panel-badge" id="t-count">0</span>
        </div>
        <table class="tbl">
          <thead>
            <tr><th>Symbol</th><th>Side</th><th>Entry</th><th>Exit</th><th>P&L</th><th>Duration</th><th>Score</th><th>Exit Reason</th></tr>
          </thead>
          <tbody id="t-body">
            <tr><td colspan="8" class="tbl-empty">No trades</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ══ ANALYTICS ══════════════════════════════════════ -->
    <div id="page-analytics" class="page">
      <div class="grid-2" style="margin-bottom:16px">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Daily P&L (30 Days)</span></div>
          <div class="chart-wrap"><canvas id="dailyChart"></canvas></div>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Cumulative P&L</span></div>
          <div class="chart-wrap"><canvas id="cumulChart"></canvas></div>
        </div>
      </div>
      <div class="grid-2">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Monthly</span></div>
          <table class="tbl">
            <thead><tr><th>Month</th><th>Trades</th><th>Win Rate</th><th>P&L</th></tr></thead>
            <tbody id="monthly-body">
              <tr><td colspan="4" class="tbl-empty">No data</td></tr>
            </tbody>
          </table>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">By Symbol</span></div>
          <table class="tbl">
            <thead><tr><th>Symbol</th><th>Trades</th><th>Win Rate</th><th>P&L</th></tr></thead>
            <tbody id="symbol-body">
              <tr><td colspan="4" class="tbl-empty">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ══ AI ENGINE ══════════════════════════════════════ -->
    <div id="page-ai" class="page">
      <div class="stats-row stats-3" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-label">Signal Threshold</div>
          <div class="stat-value c-blue" id="ai-thresh">0.25</div>
          <div class="stat-sub">Adaptive</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Size Multiplier</div>
          <div class="stat-value c-blue" id="ai-mult">1.0x</div>
          <div class="stat-sub">Smart sizing</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Evaluations</div>
          <div class="stat-value" id="ai-evals">0</div>
          <div class="stat-sub">Auto self-eval</div>
        </div>
      </div>

      <div class="grid-2" style="margin-bottom:16px">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Active Features (9/9)</span></div>
          <div class="panel-body">
            <div class="chip-wrap">
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Auto Self-Evaluation</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Adaptive Threshold</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Market Regime Detection</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Smart Position Sizing</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Correlation Filter</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Circuit Breaker</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Trade Journal AI</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Pattern Recognition</span>
              <span class="chip" style="color:#22c55e;border-color:#1a2e1a">Auto Parameter Tuning</span>
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Safety Status</span></div>
          <div class="panel-body">
            <div class="safety-row"><span style="color:#888">Emergency Stop</span><span class="badge badge-neutral" id="ai-emg">INACTIVE</span></div>
            <div class="safety-row"><span style="color:#888">Daily Loss Limit</span><span class="badge badge-ok" id="ai-daily">OK</span></div>
            <div class="safety-row"><span style="color:#888">Drawdown Limit</span><span class="badge badge-ok" id="ai-dd">OK</span></div>
            <div class="safety-row"><span style="color:#888">Circuit Breaker</span><span class="badge badge-ok" id="ai-cb">OK</span></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <span class="panel-label">Market Analysis</span>
          <button class="btn btn-neutral" onclick="fetchAI()" id="ai-btn" style="padding:4px 12px;font-size:11px">Get Analysis</button>
        </div>
        <div class="panel-body">
          <div style="color:#555;font-size:13px;line-height:1.8" id="ai-resp">Click "Get Analysis" to fetch Claude AI market analysis...</div>
        </div>
      </div>
    </div>

    <!-- ══ JOURNAL ════════════════════════════════════════ -->
    <div id="page-journal" class="page">
      <div class="panel">
        <div class="panel-head"><span class="panel-label">Trade Journal — AI Analysis</span></div>
        <div class="panel-body" id="journal-body">
          <div style="color:#333;font-size:13px">No journal entries yet. Entries are written automatically after each trade closes.</div>
        </div>
      </div>
    </div>

    <!-- ══ TRANSACTIONS ═══════════════════════════════════ -->
    <div id="page-transactions" class="page">
      <div class="stats-row stats-3" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-label">Balance</div>
          <div class="stat-value" id="tx-bal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">This Month P&L</div>
          <div class="stat-value" id="tx-month">$+0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Trades</div>
          <div class="stat-value" id="tx-total">0</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head"><span class="panel-label">Transaction History</span></div>
        <table class="tbl">
          <thead>
            <tr><th>Date</th><th>Type</th><th>Symbol</th><th>Amount</th><th>Balance After</th><th>Note</th></tr>
          </thead>
          <tbody id="tx-body">
            <tr><td colspan="6" class="tbl-empty">No transactions</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ══ CONTROL ════════════════════════════════════════ -->
    <div id="page-control" class="page">
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-head"><span class="panel-label">Bot Control</span></div>
        <div class="panel-body">
          <div class="btn-row">
            <button class="btn btn-start" onclick="botCmd('start')">▶ Start Bot</button>
            <button class="btn btn-stop" onclick="botCmd('emergency-stop')">⬛ Stop Bot</button>
            <button class="btn btn-reset" onclick="botCmd('reset-daily')">↺ Reset Daily</button>
            <button class="btn btn-neutral" onclick="fetchAll()">⟳ Refresh</button>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Bot Status</span></div>
          <div class="panel-body">
            <div class="perf-row"><span class="perf-k">Mode</span><span class="perf-v" id="c-mode">—</span></div>
            <div class="perf-row"><span class="perf-k">Running</span><span class="perf-v" id="c-run">—</span></div>
            <div class="perf-row"><span class="perf-k">Balance</span><span class="perf-v c-white" id="c-bal">—</span></div>
            <div class="perf-row"><span class="perf-k">Positions</span><span class="perf-v" id="c-pos">0/1</span></div>
            <div class="perf-row"><span class="perf-k">Total Trades</span><span class="perf-v" id="c-trades">0</span></div>
            <div class="perf-row"><span class="perf-k">Last Update</span><span class="perf-v" id="c-upd">—</span></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head"><span class="panel-label">Risk Config</span></div>
          <div class="panel-body">
            <div class="perf-row"><span class="perf-k">Daily Loss Limit</span><span class="perf-v">15%</span></div>
            <div class="perf-row"><span class="perf-k">Drawdown Limit</span><span class="perf-v">35%</span></div>
            <div class="perf-row"><span class="perf-k">SL ATR Multiplier</span><span class="perf-v">2.5×</span></div>
            <div class="perf-row"><span class="perf-k">TP Multiplier</span><span class="perf-v">1.8×</span></div>
            <div class="perf-row"><span class="perf-k">Max Positions</span><span class="perf-v">1</span></div>
            <div class="perf-row"><span class="perf-k">Risk per Trade</span><span class="perf-v">3%</span></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<script>
const API = '/api/proxy';
let prevTrades = [], charts = {}, txHistory = [];

// Clock
setInterval(() => {
  document.getElementById('tb-time').textContent = new Date().toTimeString().slice(0,8);
}, 1000);

// Nav
const titles = {overview:'Overview',positions:'Positions',trades:'Trades',analytics:'Analytics',ai:'AI Engine',journal:'Journal',transactions:'Transactions',control:'Control'};
function go(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  el.classList.add('active');
  document.getElementById('page-title').textContent = titles[page]||page;
  if(page==='analytics') renderAnalytics();
}

// API
async function api(path, method='GET') {
  const r = await fetch(`${API}?path=${path}`, {method});
  if(!r.ok) throw new Error(r.status);
  return r.json();
}

// Notify
function notify(title, body, type='info') {
  const s = document.getElementById('notifs');
  const n = document.createElement('div');
  n.className = `notif notif-${type}`;
  n.innerHTML = `<div class="n-title">${title}</div><div class="n-body">${body}</div>`;
  s.appendChild(n);
  setTimeout(() => n.remove(), 4000);
}

// Fetch all
async function fetchAll() {
  try {
    const [status, pos, trades, perf] = await Promise.all([
      api('status'), api('positions'), api('trades'), api('performance')
    ]);
    updateOverview(status, perf, trades);
    updatePositions(pos, status);
    updateTrades(trades);
    updateTransactions(trades, status);
    updateAI(status);
    updateControl(status, trades);
    document.getElementById('last-update').textContent = 'Updated: '+new Date().toTimeString().slice(0,5);
  } catch(e) {
    document.getElementById('bot-dot').className = 'status-dot off';
    document.getElementById('bot-status-text').textContent = 'Disconnected';
  }
}

function fmt(v, prefix='$') {
  const n = parseFloat(v)||0;
  return `${n>=0?prefix+'+':'-'+prefix}${Math.abs(n).toFixed(2)}`;
}

// OVERVIEW
function updateOverview(s, perf, tradesData) {
  const b = s.balance||{}, p = s.performance||{}, sf = s.safety||{};
  const bal = b.current||0, dpnl = p.daily_pnl||0, tpnl = p.total_pnl||0, wr = p.win_rate||0;
  const dd = p.current_drawdown||0;
  const sm = perf?.summary||{};
  const trades = tradesData?.trades||[];

  document.getElementById('o-bal').textContent = `$${bal.toFixed(2)}`;
  const dp = document.getElementById('o-dpnl');
  dp.textContent = fmt(dpnl); dp.className = `stat-value ${dpnl>=0?'c-green':'c-red'}`;
  const tp = document.getElementById('o-tpnl');
  tp.textContent = fmt(tpnl); tp.className = `stat-value ${tpnl>=0?'c-green':'c-red'}`;
  const wrEl = document.getElementById('o-wr');
  wrEl.textContent = `${wr.toFixed(1)}%`;
  wrEl.className = `stat-value ${wr>=50?'c-green':wr>=40?'c-yellow':'c-red'}`;
  document.getElementById('o-trades').textContent = `${p.total_trades||0} trades`;
  document.getElementById('o-pos').textContent = (s.positions||[]).length||0;
  document.getElementById('o-pos-badge').textContent = (s.positions||[]).length||0;

  // Mode
  const mode = s.bot?.mode||'paper';
  document.getElementById('o-mode').textContent = mode.toUpperCase();
  document.getElementById('tb-mode').textContent = mode.toUpperCase();
  document.getElementById('tb-mode').className = mode==='live'?'c-green':'c-yellow';
  document.getElementById('o-dd').textContent = `${dd.toFixed(2)}%`;
  document.getElementById('o-dd').className = `market-value ${dd<15?'c-green':dd<25?'c-yellow':'c-red'}`;

  // Session (time-based)
  const h = new Date().getUTCHours();
  let session = 'ASIA';
  if(h>=8&&h<16) session='LONDON';
  else if(h>=13&&h<21) session='NY';
  else if(h>=8&&h<21) session='OVERLAP';
  document.getElementById('o-session').textContent = session;

  // Perf
  document.getElementById('o-best').textContent = `$+${(sm.best_trade||0).toFixed(4)}`;
  document.getElementById('o-worst').textContent = `$${(sm.worst_trade||0).toFixed(4)}`;
  document.getElementById('o-wstreak').textContent = p.winning_trades||0;
  document.getElementById('o-lstreak').textContent = p.losing_trades||0;

  // Positions table in overview
  const pos = s.positions||[];
  const ob = document.getElementById('o-pos-body');
  if(!pos.length) { ob.innerHTML=`<tr><td colspan="6" class="tbl-empty">No open positions</td></tr>`; }
  else ob.innerHTML = pos.map(p => `<tr>
    <td style="font-weight:500">${p.symbol}</td>
    <td><span class="badge ${p.side==='Buy'?'badge-long':'badge-short'}">${p.side==='Buy'?'LONG':'SHORT'}</span></td>
    <td>${(p.entry_price||0).toFixed(4)}</td>
    <td class="${(p.unrealized_pnl||0)>=0?'c-green':'c-red'}">${(p.unrealized_pnl||0)>=0?'+':''}$${(p.unrealized_pnl||0).toFixed(4)}</td>
    <td class="c-gray">${(p.stop_loss||0).toFixed(4)}</td>
    <td class="c-gray">${getAge(p.opened_at)}</td>
  </tr>`).join('');

  // Bot status
  const running = s.bot?.is_running;
  document.getElementById('bot-dot').className = `status-dot ${running?'':'off'}`;
  document.getElementById('bot-status-text').textContent = running?'Bot Running':'Bot Stopped';

  // Scan stats (estimated from signal data)
  document.getElementById('sc-total').textContent = p.total_trades||0;
  document.getElementById('sc-signals').textContent = p.total_trades||0;
  document.getElementById('sc-regime').textContent = 0;
  document.getElementById('sc-corr').textContent = 0;
  document.getElementById('sc-rejected').textContent = 0;
  document.getElementById('sc-approved').textContent = p.total_trades||0;
}

// POSITIONS
function updatePositions(data, status) {
  const pos = data.positions||[];
  const unreal = pos.reduce((s,p)=>s+(p.unrealized_pnl||0),0);
  document.getElementById('p-count').textContent = `${pos.length}/1`;
  const ur = document.getElementById('p-unreal');
  ur.textContent = `$${unreal.toFixed(4)}`;
  ur.className = `stat-value ${unreal>=0?'c-green':'c-red'}`;

  const body = document.getElementById('p-body');
  if(!pos.length) { body.innerHTML=`<tr><td colspan="9" class="tbl-empty">No open positions</td></tr>`; return; }
  body.innerHTML = pos.map(p => {
    const pnl = p.unrealized_pnl||0, entry = p.entry_price||0, cur = p.current_price||entry;
    const pct = entry?((cur-entry)/entry*100*(p.side==='Buy'?1:-1)).toFixed(2):'0.00';
    return `<tr>
      <td style="font-weight:500">${p.symbol}</td>
      <td><span class="badge ${p.side==='Buy'?'badge-long':'badge-short'}">${p.side==='Buy'?'LONG':'SHORT'}</span></td>
      <td>${entry.toFixed(4)}</td><td>${cur.toFixed(4)}</td>
      <td class="${pnl>=0?'c-green':'c-red'}">${pnl>=0?'+':''}$${pnl.toFixed(4)}</td>
      <td class="${pnl>=0?'c-green':'c-red'}">${pct}%</td>
      <td class="c-gray">${(p.stop_loss||0).toFixed(4)}</td>
      <td class="c-gray">${(p.take_profit||0).toFixed(4)}</td>
      <td class="c-gray">${getAge(p.opened_at)}</td>
    </tr>`;
  }).join('');
}

// TRADES
function updateTrades(data) {
  const trades = data.trades||[];
  if(prevTrades.length && trades.length>prevTrades.length) {
    const t = trades[0];
    if(t.pnl>=0) notify('Trade WIN ✓', `${t.symbol} +$${t.pnl.toFixed(2)}`, 'win');
    else notify('Trade LOSS', `${t.symbol} $${t.pnl.toFixed(2)}`, 'loss');
  }
  prevTrades = trades;
  document.getElementById('t-count').textContent = trades.length;
  const body = document.getElementById('t-body');
  if(!trades.length) { body.innerHTML=`<tr><td colspan="8" class="tbl-empty">No trades</td></tr>`; return; }
  body.innerHTML = trades.map(t => {
    const pnl = t.pnl||0, dur = getDur(t.opened_at,t.closed_at);
    return `<tr>
      <td style="font-weight:500">${t.symbol}</td>
      <td><span class="badge ${t.side==='Buy'?'badge-long':'badge-short'}">${t.side==='Buy'?'LONG':'SHORT'}</span></td>
      <td>${(t.entry_price||0).toFixed(4)}</td><td>${(t.exit_price||0).toFixed(4)}</td>
      <td class="${pnl>=0?'c-green':'c-red'}" style="font-weight:500">${pnl>=0?'+':''}$${pnl.toFixed(4)}</td>
      <td class="c-gray">${dur}</td>
      <td class="c-gray">${(t.signal_score||0).toFixed(3)}</td>
      <td class="c-gray">${t.notes||'—'}</td>
    </tr>`;
  }).join('');
}

// TRANSACTIONS — deposit/withdraw/trade history
function updateTransactions(data, status) {
  const trades = data.trades||[];
  const bal = status.balance?.current||0;
  document.getElementById('tx-bal').textContent = `$${bal.toFixed(2)}`;
  document.getElementById('tx-total').textContent = trades.length;
  const dpnl = status.performance?.daily_pnl||0;
  const mp = document.getElementById('tx-month');
  mp.textContent = `${dpnl>=0?'$+':'$-'}${Math.abs(dpnl).toFixed(2)}`;
  mp.className = `stat-value ${dpnl>=0?'c-green':'c-red'}`;

  const body = document.getElementById('tx-body');
  if(!trades.length) { body.innerHTML=`<tr><td colspan="6" class="tbl-empty">No transactions</td></tr>`; return; }
  body.innerHTML = trades.map(t => {
    const pnl = t.pnl||0;
    const type = pnl>=0?'Trade WIN':'Trade LOSS';
    const cls = pnl>=0?'tx-trade c-green':'tx-trade c-red';
    const date = t.closed_at?new Date(t.closed_at).toLocaleString('id-ID',{dateStyle:'short',timeStyle:'short'}):'—';
    return `<tr>
      <td class="c-gray">${date}</td>
      <td><span class="${cls}">${type}</span></td>
      <td style="font-weight:500">${t.symbol}</td>
      <td class="${pnl>=0?'c-green':'c-red'}" style="font-weight:500">${pnl>=0?'+':''}$${pnl.toFixed(4)}</td>
      <td class="c-gray">—</td>
      <td class="c-gray">${t.notes||'—'}</td>
    </tr>`;
  }).join('');
}

// ANALYTICS
function renderAnalytics() {
  const trades = prevTrades;
  // Cumul chart
  let cumul = 0;
  const cumulData = trades.map(t => { cumul+=(t.pnl||0); return cumul; });
  const ctx = document.getElementById('cumulChart');
  if(ctx && trades.length) {
    if(charts.cumul) charts.cumul.destroy();
    charts.cumul = new Chart(ctx, {
      type:'line',
      data:{labels:trades.map((_,i)=>`#${i+1}`),datasets:[{
        data:cumulData,
        borderColor:'#22c55e',backgroundColor:'rgba(34,197,94,0.05)',
        borderWidth:1.5,fill:true,tension:0.3,pointRadius:0
      }]},
      options:{responsive:true,maintainAspectRatio:false,
        scales:{x:{ticks:{color:'#333',font:{size:9}},grid:{display:false}},
          y:{grid:{color:'#1a1a1a'},ticks:{color:'#444',font:{size:9},callback:v=>`$${v.toFixed(2)}`}}},
        plugins:{legend:{display:false}},animation:false}
    });
  }
  // Daily bar
  const ctx2 = document.getElementById('dailyChart');
  if(ctx2 && trades.length) {
    if(charts.daily) charts.daily.destroy();
    charts.daily = new Chart(ctx2, {
      type:'bar',
      data:{labels:trades.map((_,i)=>`#${i+1}`),datasets:[{
        data:trades.map(t=>t.pnl||0),
        backgroundColor:trades.map(t=>(t.pnl||0)>=0?'rgba(34,197,94,0.5)':'rgba(239,68,68,0.5)'),
        borderColor:trades.map(t=>(t.pnl||0)>=0?'#22c55e':'#ef4444'),
        borderWidth:1,borderRadius:2
      }]},
      options:{responsive:true,maintainAspectRatio:false,
        scales:{x:{ticks:{color:'#333',font:{size:9}},grid:{display:false}},
          y:{grid:{color:'#1a1a1a'},ticks:{color:'#444',font:{size:9},callback:v=>`$${v.toFixed(2)}`}}},
        plugins:{legend:{display:false}},animation:false}
    });
  }
  // By symbol
  const syms = {};
  trades.forEach(t => {
    if(!syms[t.symbol]) syms[t.symbol] = {trades:0,wins:0,pnl:0};
    syms[t.symbol].trades++;
    if(t.pnl>0) syms[t.symbol].wins++;
    syms[t.symbol].pnl += t.pnl||0;
  });
  const sb = document.getElementById('symbol-body');
  const entries = Object.entries(syms);
  if(!entries.length) { sb.innerHTML=`<tr><td colspan="4" class="tbl-empty">No data</td></tr>`; }
  else sb.innerHTML = entries.sort((a,b)=>b[1].pnl-a[1].pnl).map(([sym,d])=>`<tr>
    <td style="font-weight:500">${sym}</td>
    <td>${d.trades}</td>
    <td class="${(d.wins/d.trades)>=0.5?'c-green':'c-red'}">${((d.wins/d.trades)*100).toFixed(0)}%</td>
    <td class="${d.pnl>=0?'c-green':'c-red'}">${d.pnl>=0?'+':''}$${d.pnl.toFixed(4)}</td>
  </tr>`).join('');
}

// AI
function updateAI(s) {
  const sf = s.safety||{};
  setSafety('ai-emg', !sf.emergency_stop, sf.emergency_stop?'ACTIVE':'INACTIVE');
  setSafety('ai-daily', !sf.daily_loss_hit, sf.daily_loss_hit?'HIT':'OK');
  setSafety('ai-dd', !sf.drawdown_limit_hit, sf.drawdown_limit_hit?'HIT':'OK');
}
function setSafety(id, ok, label) {
  const el = document.getElementById(id);
  el.textContent = label;
  el.className = `badge ${ok?'badge-ok':'badge-hit'}`;
}
async function fetchAI() {
  const btn = document.getElementById('ai-btn');
  btn.textContent = 'Analyzing...'; btn.disabled = true;
  try {
    const d = await api('ai/market-analysis');
    document.getElementById('ai-resp').textContent = d.analysis||d.message||'No analysis available';
  } catch(e) {
    document.getElementById('ai-resp').textContent = 'Error: '+e.message;
  }
  btn.textContent = 'Get Analysis'; btn.disabled = false;
}

// CONTROL
function updateControl(s, tradesData) {
  const mode = s.bot?.mode||'paper';
  document.getElementById('c-mode').textContent = mode.toUpperCase();
  document.getElementById('c-run').textContent = s.bot?.is_running?'Running':'Stopped';
  document.getElementById('c-run').className = `perf-v ${s.bot?.is_running?'c-green':'c-red'}`;
  document.getElementById('c-bal').textContent = `$${(s.balance?.current||0).toFixed(4)}`;
  document.getElementById('c-pos').textContent = `${(s.positions||[]).length||0}/1`;
  document.getElementById('c-trades').textContent = s.performance?.total_trades||0;
  document.getElementById('c-upd').textContent = new Date().toTimeString().slice(0,8);
}

async function botCmd(action) {
  try {
    await fetch(`${API}?path=${action}`, {method:'POST'});
    const labels = {'start':'Bot started','emergency-stop':'Bot stopped','reset-daily':'Daily reset'};
    notify(labels[action]||action, '', 'info');
    setTimeout(fetchAll, 1000);
  } catch(e) { notify('Error', e.message, 'loss'); }
}

// HELPERS
function getAge(iso) {
  if(!iso) return '—';
  const d=(Date.now()-new Date(iso).getTime())/1000;
  if(d<60) return `${Math.floor(d)}s`;
  if(d<3600) return `${Math.floor(d/60)}m`;
  return `${Math.floor(d/3600)}h`;
}
function getDur(a,b) {
  if(!a||!b) return '—';
  const d=(new Date(b)-new Date(a))/1000;
  if(d<60) return `${Math.floor(d)}s`;
  if(d<3600) return `${Math.floor(d/60)}m`;
  return `${Math.floor(d/3600)}h`;
}

fetchAll();
setInterval(fetchAll, 60000);
</script>
</body>
</html>
